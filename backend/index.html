<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Test Caro Socket</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
      body {
        font-family: sans-serif;
        margin: 20px;
      }

      input,
      button {
        margin: 5px;
      }

      pre {
        background: #f0f0f0;
        padding: 10px;
        max-height: 300px;
        overflow: auto;
      }
    </style>
  </head>

  <body>
    <h2>Test Socket Caro</h2>

    <div>
      <label
        >JWT Token:
        <input type="text" id="tokenInput" style="width: 400px" /></label
      ><br />
      <label>Room Name: <input type="text" id="roomName" value="TEST" /></label>
      <label
        >Password (for create):
        <input type="text" id="roomPassword" value="123"
      /></label>
      <label
        >Max Players:
        <input type="number" id="roomMax" value="2" min="2" max="10" /></label
      ><br />
      <label
        >Room ID (for join):
        <input
          type="text"
          id="roomIdInput"
          placeholder="Nh·∫≠p Room ID ƒë·ªÉ join"
          style="width: 200px" /></label
      ><br />
      <label
        >Password (for join):
        <input
          type="text"
          id="joinPassword"
          value="123"
          style="width: 200px" /></label
      ><br />
      <button id="connectBtn">K·∫øt n·ªëi Socket</button>
      <button id="joinBtn">T·∫°o & Join ph√≤ng</button>
      <button id="directJoinBtn">Join Room</button>
      <button id="readyBtn">Ready</button>
      <button id="startBtn">Start game</button>
      <button id="moveBtn">Move (random)</button>
      <button id="drawBtn">Draw</button>
      <button id="acceptDrawBtn">Accept Draw</button>
      <button id="resignBtn">Resign</button>
      <button id="leaveBtn">Leave Room</button>
    </div>

    <pre id="log"></pre>

    <script>
      const logEl = document.getElementById("log");

      function log(msg, data) {
        logEl.textContent +=
          msg + (data ? " " + JSON.stringify(data, null, 2) : "") + "\n";
      }

      let socket = null,
        roomId = null,
        myMark = null,
        boardSize = 20;

      // ----- CONNECT SOCKET -----
      document.getElementById("connectBtn").onclick = () => {
        const token = document.getElementById("tokenInput").value.trim();
        if (!token) return alert("Nh·∫≠p JWT token!");

        socket = io("http://localhost:5000", {
          auth: {
            token,
          },
        });

        socket.on("connect", () =>
          log("‚úÖ Connected", {
            id: socket.id,
          })
        );
        socket.on("disconnect", (reason) => log("‚ùå Disconnected", reason));

        socket.on("room_update", (data) => log("üì¢ Room updated", data));
        socket.on("game_start", (data) => {
          log("üéÆ Game started", data);
          // S·ª≠a l·ªói syntax: me?.mark
          const me = data.players.find((p) => p.userId === socket.user?._id);
          myMark = me?.mark || "X";
          log("My mark", { mark: myMark });
        });
        socket.on("opponent_move", (data) => log("üü¢ Opponent moved", data));
        socket.on("match_end", (data) => log("üèÅ Match ended", data));
        socket.on("match_draw", () => log("ü§ù Match draw"));
        socket.on("draw_request_from_opponent", () =>
          log("‚úã Draw request received")
        );
        socket.on("join_error", (data) => log("‚ùå Join error", data));
        socket.on("move_rejected", (data) => log("‚ùå Move rejected", data)); // Th√™m ƒë·ªÉ debug reject

        // Ping server m·ªói 5s (gi·ªØ nh∆∞ng kh√¥ng log n·∫øu kh√¥ng c·∫ßn)
        setInterval(() => {
          if (socket && socket.connected) {
            socket.emit("ping_server");
            // log("üì° Ping sent"); // T·∫Øt log ƒë·ªÉ s·∫°ch
          }
        }, 5000);
      };

      // ----- CREATE & JOIN ROOM -----
      document.getElementById("joinBtn").onclick = async () => {
        const token = document.getElementById("tokenInput").value.trim();
        if (!token) return alert("Nh·∫≠p JWT token!");
        const name = document.getElementById("roomName").value.trim() || "TEST";
        const password = document.getElementById("roomPassword").value.trim();
        const maxPlayers =
          parseInt(document.getElementById("roomMax").value) || 2;

        // T·∫°o ph√≤ng qua API
        const resp = await fetch("http://localhost:5000/api/room/create", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token,
          },
          body: JSON.stringify({
            name,
            password,
            maxPlayers,
          }),
        });
        const data = await resp.json();
        if (data.error) return log("‚ùå Create room error", data);
        roomId = data.data._id;
        log("‚úÖ Room created", data.data);

        // Join ph√≤ng
        socket.emit("join_room", {
          roomId,
          password,
        });
      };

      // ----- DIRECT JOIN ROOM -----
      document.getElementById("directJoinBtn").onclick = () => {
        const roomIdInput = document.getElementById("roomIdInput").value.trim();
        const password = document.getElementById("joinPassword").value.trim();
        if (!roomIdInput) return alert("Nh·∫≠p Room ID!");
        if (!password) return alert("Nh·∫≠p Password (for join)!");

        roomId = roomIdInput;
        log("üîó Attempting to join room", { roomId });

        socket.emit("join_room", {
          roomId,
          password,
        });
      };

      // ----- READY -----
      document.getElementById("readyBtn").onclick = () => {
        if (!roomId) return alert("Ch∆∞a c√≥ room");
        socket.emit("player_ready", {
          roomId,
        });
      };

      // ----- START ----- (Gi·ªØ nh∆∞ng comment n·∫øu d√πng auto-start t·ª´ ready)
      document.getElementById("startBtn").onclick = () => {
        if (!roomId) return alert("Ch∆∞a c√≥ room");
        socket.emit("start_game", {
          roomId,
        });
      };

      // ----- MOVE -----
      document.getElementById("moveBtn").onclick = () => {
        if (!roomId || !myMark) return alert("Ch∆∞a b·∫Øt ƒë·∫ßu game");
        // Th√™m check bounds cho random
        const x = Math.floor(Math.random() * boardSize);
        const y = Math.floor(Math.random() * boardSize);
        log("‚û°Ô∏è Move", {
          x,
          y,
          mark: myMark,
        });
        socket.emit("player_move", {
          roomId,
          x,
          y,
        });
      };

      // C√°c button kh√°c gi·ªØ nguy√™n...
      // ----- DRAW -----
      document.getElementById("drawBtn").onclick = () => {
        if (!roomId) return alert("Ch∆∞a c√≥ room");
        socket.emit("draw_request", {
          roomId,
        });
      };

      // ----- ACCEPT DRAW -----
      document.getElementById("acceptDrawBtn").onclick = () => {
        if (!roomId) return alert("Ch∆∞a c√≥ room");
        socket.emit("draw_accept", {
          roomId,
        });
      };

      // ----- RESIGN -----
      document.getElementById("resignBtn").onclick = () => {
        if (!roomId) return alert("Ch∆∞a c√≥ room");
        socket.emit("resign", {
          roomId,
        });
      };

      // ----- LEAVE -----
      document.getElementById("leaveBtn").onclick = () => {
        if (!roomId) return alert("Ch∆∞a c√≥ room");
        socket.emit("leave_room", {
          roomId,
        });
        roomId = null;
        myMark = null;
      };
    </script>
  </body>
</html>
